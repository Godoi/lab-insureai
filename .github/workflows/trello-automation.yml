name: ðŸ”„ GitHub + Trello Automation

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]
    branches:
      - release/testing
      - main
  issues:
    types: [opened, closed]

jobs:
  automate-trello:
    runs-on: ubuntu-latest
    environment: TRELLO_API
    env:
      LIST_TESTS_ID: ${{ vars.TRELLO_LIST_TESTS_ID }}
      LIST_DONE_ID: ${{ vars.TRELLO_LIST_DONE_ID }}
      LIST_BUGS_ID: ${{ vars.TRELLO_LIST_BUGS_ID }}

    steps:
      - name: ðŸ”’ Validar link do Trello no corpo do PR
        run: |
          echo "ðŸ” Validando presenÃ§a do link do Trello..."
          # NÃ£o imprima o corpo completo para evitar injeÃ§Ã£o de comando
          BODY="${{ github.event.pull_request.body }}"
          
          if [ -z "$BODY" ]; then
            echo "::error::âŒ Corpo do PR estÃ¡ vazio."
            exit 1
          fi

          if ! echo "$BODY" | grep -qE 'https://trello.com/c/[a-zA-Z0-9]+'; then
            echo "::error::âŒ Falha: O corpo do PR deve conter um link do Trello (ex: https://trello.com/c/kz7q1L3x)"
            exit 1
          else
            echo "âœ… Link do Trello encontrado"
          fi

      # ðŸ§¹ Extrair CARD_ID do link no corpo do PR
      - name: ðŸ§¹ Extrair TRELLO_CARD_ID do PR
        run: |
          echo "ðŸ” Procurando link do Trello no PR..."
          CARD_URL=$(echo "${{ github.event.pull_request.body }}" | grep -oE 'https://trello.com/c/[a-zA-Z0-9]+' | head -1)
          if [ -n "$CARD_URL" ]; then
            CARD_ID=$(echo "$CARD_URL" | awk -F'/' '{print $5}')
            echo "CARD_ID=$CARD_ID" >> $GITHUB_ENV
            echo "::notice title=Card encontrado::$CARD_ID"
          else
            echo "::warning title=Card nÃ£o encontrado::Adicione: https://trello.com/c/abc123"
          fi

      # ðŸŸ¡ Mover para TESTS se PR for para release/testing
      - name: ðŸŸ¡ Mover para TESTS (release/testing)
        if: (github.event.pull_request.target.ref == 'release/testing' || github.base_ref == 'release/testing') && env.CARD_ID != ''
        run: |
          echo "ðŸšš Movendo card ${{ env.CARD_ID }} para TESTS..."
          curl -X PUT "https://api.trello.com/1/cards/${{ env.CARD_ID }}" \
            --data-urlencode "idList=${{ env.LIST_TESTS_ID }}" \
            --data-urlencode "key=${{ secrets.TRELLO_API_KEY }}" \
            --data-urlencode "token=${{ secrets.TRELLO_TOKEN }}"

      # ðŸŸ¢ Mover para âœ… Done se PR for mergiado no main
      - name: ðŸŸ¢ Mover para âœ… Done (merge no main)
        if: github.event.pull_request.merged == true && (github.event.pull_request.target.ref == 'main' || github.base_ref == 'main') && env.CARD_ID != ''
        run: |
          echo "âœ… Movendo card ${{ env.CARD_ID }} para DONE..."
          curl -X PUT "https://api.trello.com/1/cards/${{ env.CARD_ID }}" \
            --data-urlencode "idList=${{ env.LIST_DONE_ID }}" \
            --data-urlencode "key=${{ secrets.TRELLO_API_KEY }}" \
            --data-urlencode "token=${{ secrets.TRELLO_TOKEN }}"

      # ðŸ“ Atualizar descriÃ§Ã£o com link do deploy
      - name: ðŸ“ Atualizar descriÃ§Ã£o com link do deploy
        if: github.event.pull_request.merged == true && (github.event.pull_request.target.ref == 'main' || github.base_ref == 'main') && env.CARD_ID != ''
        run: |
          DESCRIPTION="âœ… **Tarefa concluÃ­da e implantada em produÃ§Ã£o**\n\n"
          DESCRIPTION+="ðŸ”— [Pull Request #${{ github.event.number }}](${{ github.event.pull_request.html_url }})\n"
          DESCRIPTION+="ðŸ“… ${{ github.event.pull_request.merged_at }}\n"
          DESCRIPTION+="ðŸ‘¤ por @${{ github.actor }}\n\n"
          DESCRIPTION+="---\nEste card foi atualizado automaticamente pela integraÃ§Ã£o GitHub + Trello."

          curl -X PUT "https://api.trello.com/1/cards/${{ env.CARD_ID }}" \
            --data-urlencode "desc=$DESCRIPTION" \
            --data-urlencode "key=${{ secrets.TRELLO_API_KEY }}" \
            --data-urlencode "token=${{ secrets.TRELLO_TOKEN }}"

      # ðŸ’¬ Notificar conclusÃ£o no Trello
      - name: ðŸ’¬ Notificar conclusÃ£o no Trello
        if: github.event.pull_request.merged == true && (github.event.pull_request.target.ref == 'main' || github.base_ref == 'main') && env.CARD_ID != ''
        run: |
          echo "ðŸ’¬ Notificando conclusÃ£o no card ${{ env.CARD_ID }}..."
          curl -X POST "https://api.trello.com/1/cards/${{ env.CARD_ID }}/actions/comments" \
            --data-urlencode "text=âœ… Tarefa concluÃ­da e movida para DONE via automaÃ§Ã£o do GitHub Actions. PR: ${{ github.event.pull_request.html_url }}" \
            --data-urlencode "key=${{ secrets.TRELLO_API_KEY }}" \
            --data-urlencode "token=${{ secrets.TRELLO_TOKEN }}"

      # ðŸ› Criar card para nova issue com label 'bug'
      - name: ðŸ› Criar card para bug
        if: github.event_name == 'issues' && github.event.action == 'opened' && contains(github.event.issue.labels.*.name, 'bug')
        run: |
          echo "ðŸ†• Criando card para bug..."
          curl -X POST "https://api.trello.com/1/cards" \
            --data-urlencode "name=[BUG] ${{ github.event.issue.title }}" \
            --data-urlencode "desc=Reportado no GitHub: ${{ github.event.issue.html_url }}\n\n${{ github.event.issue.body }}" \
            --data-urlencode "idList=${{ env.LIST_BUGS_ID }}" \
            --data-urlencode "key=${{ secrets.TRELLO_API_KEY }}" \
            --data-urlencode "token=${{ secrets.TRELLO_TOKEN }}"

      # ðŸ”„ Notificar no card se o PR for atualizado (synchronize)
      - name: ðŸ”„ Notificar atualizaÃ§Ã£o no PR
        if: github.event.action == 'synchronize' && env.CARD_ID != ''
        run: |
          echo "ðŸ”„ Notificando atualizaÃ§Ã£o no card ${{ env.CARD_ID }}..."
          curl -X POST "https://api.trello.com/1/cards/${{ env.CARD_ID }}/actions/comments" \
            --data-urlencode "text=ðŸ”„ PR atualizado: [Acessar PR](${{ github.event.pull_request.html_url }}) por @${{ github.actor }}" \
            --data-urlencode "key=${{ secrets.TRELLO_API_KEY }}" \
            --data-urlencode "token=${{ secrets.TRELLO_TOKEN }}"

      # ðŸ“ Fallback: Registrar erro localmente
      - name: ðŸ“ Fallback - Registrar erro localmente
        if: failure()
        run: |
          mkdir -p logs
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S")
          PR_NUM=${{ github.event.number }}
          PR_TITLE="${{ github.event.pull_request.title }}"
          TARGET_BRANCH="${{ github.event.pull_request.target.ref }}"
          
          echo "[$TIMESTAMP] FALHA: PR #$PR_NUM '$PR_TITLE' para $TARGET_BRANCH" >> logs/trello-fallback.log
          echo "Erro na automaÃ§Ã£o Trello. Verifique os logs do workflow." >> logs/trello-fallback.log
          echo "---" >> logs/trello-fallback.log
          
          echo "âœ… Fallback log salvo em: logs/trello-fallback.log"
          cat logs/trello-fallback.log